<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manual Chatbot Test</title>
    <meta name="chatbot-tenant-id" content="687d104974f2f8e6e27e032e" />
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .test-button {
        padding: 10px 20px;
        margin: 10px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .result {
        padding: 10px;
        margin: 10px;
        border-radius: 5px;
      }
      .success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
      }
    </style>
  </head>
  <body>
    <h1>Manual Chatbot Test</h1>
    <p>Let's manually test each step of the chatbot initialization:</p>

    <button class="test-button" onclick="step1()">
      Step 1: Check Tenant ID
    </button>
    <button class="test-button" onclick="step2()">Step 2: Test Init API</button>
    <button class="test-button" onclick="step3()">
      Step 3: Create Widget Manually
    </button>
    <button class="test-button" onclick="step4()">
      Step 4: Load Embed Script
    </button>

    <div id="results"></div>

    <script>
      function addResult(message, type = 'info') {
          const div = document.createElement('div');
          div.className = `result ${type}`;
          div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
          document.getElementById('results').appendChild(div);
      }

      function step1() {
          const tenantMeta = document.querySelector('meta[name="chatbot-tenant-id"]');
          if (tenantMeta) {
              const tenantId = tenantMeta.getAttribute('content');
              addResult(`‚úÖ Tenant ID found: ${tenantId}`, 'success');
          } else {
              addResult('‚ùå Tenant ID meta tag not found', 'error');
          }
      }

      async function step2() {
          try {
              const tenantMeta = document.querySelector('meta[name="chatbot-tenant-id"]');
              const tenantId = tenantMeta.getAttribute('content');

              const response = await fetch('/api/chatbot/init', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                      tenantId: tenantId,
                      domain: window.location.hostname
                  })
              });

              if (response.ok) {
                  const data = await response.json();
                  addResult(`‚úÖ Init API Success - Token: ${data.token ? 'received' : 'missing'}`, 'success');
                  window.testToken = data.token; // Save for step 3
                  window.testConfig = data.config;
              } else {
                  addResult(`‚ùå Init API Failed: ${response.status}`, 'error');
              }
          } catch (error) {
              addResult(`‚ùå Init API Error: ${error.message}`, 'error');
          }
      }

      function step3() {
          if (!window.testToken) {
              addResult('‚ùå No token available. Run Step 2 first.', 'error');
              return;
          }

          // Create a simple widget manually
          const widgetHTML = \`
              <div id="manual-chatbot-widget" style="
                  position: fixed;
                  bottom: 20px;
                  right: 20px;
                  z-index: 9999;
                  width: 60px;
                  height: 60px;
                  background: #3B82F6;
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: white;
                  font-size: 24px;
                  cursor: pointer;
                  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
              ">
                  üí¨
              </div>
          \`;

          document.body.insertAdjacentHTML('beforeend', widgetHTML);

          document.getElementById('manual-chatbot-widget').addEventListener('click', async () => {
              const message = prompt('Enter a test message:');
              if (message) {
                  try {
                      const response = await fetch('/api/chat', {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json',
                              'Authorization': \`Bearer \${window.testToken}\`
                          },
                          body: JSON.stringify({ message: message })
                      });

                      if (response.ok) {
                          const data = await response.json();
                          alert(\`AI Response: \${data.response}\`);
                      } else {
                          alert(\`Error: \${response.status}\`);
                      }
                  } catch (error) {
                      alert(\`Error: \${error.message}\`);
                  }
              }
          });

          addResult('‚úÖ Manual widget created! Look for blue circle in bottom-right.', 'success');
      }

      function step4() {
          const script = document.createElement('script');
          script.src = '/embed';
          script.onload = () => addResult('‚úÖ Embed script loaded', 'success');
          script.onerror = () => addResult('‚ùå Embed script failed to load', 'error');
          document.head.appendChild(script);
      }
    </script>
  </body>
</html>
